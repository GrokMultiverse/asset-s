<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrokMultiverse | Official Pioneer Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://unpkg.com/@solana/web3.js@1.70.3/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@coral-xyz/anchor@0.29.0/dist/browser.anchor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        :root { --cyan: #00f2ff; --blue: #0072ff; --dark: #020202; }
        body { background-color: var(--dark); color: #fff; font-family: 'Space Grotesk', sans-serif; overflow-x: hidden; }
        
        /* Animations & Backgrounds */
        .banner-container { position: relative; height: 350px; border-radius: 32px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .moving-bg { 
            position: absolute; width: 200%; height: 100%; 
            background: linear-gradient(rgba(2,2,2,0.7), rgba(2,2,2,0.7)), url('https://raw.githubusercontent.com/GrokMultiverse/asset-s/d3ae39ad61ae3d9045bbcbe94b87cb04932c56ab/banner.jpg');
            background-size: cover; animation: moveBanner 50s linear infinite; will-change: transform;
        }
        @keyframes moveBanner { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass:hover { border-color: var(--cyan); background: rgba(255, 255, 255, 0.04); transform: translateY(-4px); }
        
        /* Buttons & Toast */
        .btn-connect { background: linear-gradient(90deg, var(--cyan), var(--blue)); color: #000; font-weight: 800; border-radius: 99px; transition: 0.3s; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); cursor: pointer; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--cyan); color: #000; padding: 12px 24px; border-radius: 12px; font-weight: bold; transform: translateY(200%); transition: 0.4s; z-index: 9999; }
        .toast.show { transform: translateY(0); }
        
        /* Helper Utilities */
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="toast" class="toast">Action Successful!</div>

    <nav class="max-w-7xl mx-auto flex justify-between items-center mb-10 sticky top-4 z-50 bg-black/40 backdrop-blur-lg p-5 rounded-3xl border border-white/10">
        <div class="flex items-center gap-4">
            <img src="https://raw.githubusercontent.com/GrokMultiverse/asset-s/d3ae39ad61ae3d9045bbcbe94b87cb04932c56ab/logo.png" class="w-12 h-12 rounded-xl border border-cyan-500/20">
            <span class="text-2xl font-bold tracking-tighter uppercase italic">Grok<span class="text-cyan-400">Multiverse</span></span>
        </div>
        <div class="hidden md:flex gap-6 text-[10px] font-black uppercase tracking-widest text-gray-400">
            <a href="https://faucet.solana.com/" target="_blank" class="text-cyan-400 hover:underline">Official Faucet</a>
            <a href="https://x.com/GrokMultiverse" target="_blank" class="hover:text-cyan-400 transition">Twitter</a>
        </div>
        <button onclick="connectWallet()" id="walletBtn" class="btn-connect px-8 py-3 text-[10px] uppercase tracking-widest">Connect Wallet</button>
    </nav>

    <header class="max-w-7xl mx-auto mb-16">
        <div class="banner-container flex items-center justify-center text-center p-8">
            <div class="moving-bg"></div>
            <div class="relative z-10 max-w-2xl">
                <h1 class="text-5xl md:text-7xl font-black italic uppercase mb-4 tracking-tighter">The <span class="text-cyan-400">Portal</span></h1>
                <p class="text-gray-300 text-sm md:text-base leading-relaxed opacity-90 font-medium">
                    Connect via Phantom, Solflare or Mobile Adapter. Initialize your Neural Link to begin mining points on-chain.
                </p>
                <div class="mt-6 p-4 bg-cyan-400/10 border border-cyan-400/20 rounded-xl inline-block">
                    <p class="text-[10px] font-black uppercase text-cyan-400 mb-2">Devnet Mode</p>
                    <p class="text-[11px] text-gray-400">Ensure your wallet is on **Devnet** and has SOL for gas fees.</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            
            <div class="lg:col-span-2 glass p-10 flex flex-col md:flex-row items-center gap-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-cyan-400"></div>
                <div class="w-24 h-24 rounded-full border-2 border-cyan-400/30 flex items-center justify-center bg-cyan-400/5">
                    <i id="userIcon" class="fa-solid fa-user-astronaut text-4xl text-cyan-400"></i>
                </div>
                <div class="flex-1 w-full">
                    <div class="flex justify-between items-center mb-4">
                        <p id="addrDisplay" class="text-gray-500 font-mono text-xs uppercase tracking-widest">Not Connected</p>
                        <span id="badgeStatus" class="hidden text-[9px] bg-cyan-500/20 text-cyan-400 px-2 py-1 rounded border border-cyan-500/20 font-bold uppercase">Pioneer</span>
                    </div>
                    
                    <div class="flex gap-12 mb-6">
                        <div><p class="text-[10px] text-gray-500 font-bold uppercase mb-1">On-Chain Points</p><p id="totalPts" class="text-5xl font-black italic">--</p></div>
                        <div><p class="text-[10px] text-gray-500 font-bold uppercase mb-1">Referrals</p><p id="refCount" class="text-5xl font-black italic text-gray-400">--</p></div>
                    </div>

                    <div id="referralBox" class="hidden p-4 bg-black/40 rounded-xl border border-white/5 flex items-center justify-between">
                        <div>
                            <p class="text-[9px] text-cyan-400 font-bold uppercase mb-1">Your Referral Code</p>
                            <p id="refCodeDisplay" class="text-xl font-mono font-bold tracking-widest text-white">------</p>
                        </div>
                        <button onclick="copyReferralLink()" class="flex items-center gap-2 text-[10px] bg-white text-black px-4 py-2 rounded-lg font-black uppercase hover:bg-cyan-400 transition">
                            <i class="fa-regular fa-copy"></i> Copy Link
                        </button>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <button id="mainActionBtn" onclick="initializeUser()" class="bg-cyan-400 text-black px-10 py-5 rounded-2xl text-[11px] font-black uppercase tracking-widest hover:shadow-[0_0_20px_rgba(0,242,255,0.4)] transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Initialize Account
                    </button>
                    <p id="statusMsg" class="text-[9px] text-center text-gray-500 uppercase tracking-widest">Required to earn</p>
                </div>
            </div>
            
            <div class="glass p-10">
                <h4 class="text-[11px] font-black text-cyan-400 uppercase mb-8 flex items-center gap-2">Referral Tiers</h4>
                <div class="space-y-4 text-[10px] font-bold">
                    <div class="flex justify-between p-3 rounded-xl bg-white/5 border border-white/5"><span>BRONZE</span> <span>5 Refs</span></div>
                    <div class="flex justify-between p-3 rounded-xl bg-white/5 border border-white/5"><span>SILVER</span> <span>25 Refs</span></div>
                    <div class="flex justify-between p-3 rounded-xl bg-cyan-400/10 border border-cyan-400/20 text-cyan-400 font-black"><span>GOLD</span> <span>100 Refs</span></div>
                </div>
            </div>
        </div>

        <h3 class="text-xs font-black mb-8 italic tracking-[0.2em] text-gray-500 uppercase ml-2">Smart Tasks</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-16">
            <div class="glass p-8 text-center border-b-4 border-cyan-500/50">
                <i class="fa-solid fa-link text-cyan-400 text-2xl mb-4"></i>
                <h4 class="text-[11px] font-black uppercase mb-1">Wallet Link</h4>
                <p class="text-2xl font-black italic mb-5">200 PTS</p>
                <div class="w-full bg-white/5 py-3 rounded-xl text-[10px] font-black uppercase text-gray-400">Auto (On Init)</div>
            </div>
            <div class="glass p-8 text-center">
                <i class="fa-brands fa-x-twitter text-white text-2xl mb-4"></i>
                <h4 class="text-[11px] font-black uppercase mb-1">Follow X</h4>
                <p class="text-2xl font-black italic mb-5">100 PTS</p>
                <a href="https://x.com/GrokMultiverse" target="_blank" class="block w-full border border-white/10 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-white/10">Verify</a>
            </div>
            <div class="glass p-8 text-center">
                <i class="fa-brands fa-telegram text-blue-400 text-2xl mb-4"></i>
                <h4 class="text-[11px] font-black uppercase mb-1">Join TG</h4>
                <p class="text-2xl font-black italic mb-5">100 PTS</p>
                <a href="https://t.me/GrokMultiverse" target="_blank" class="block w-full border border-white/10 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-white/10">Join</a>
            </div>
            <div class="glass p-8 text-center">
                <i class="fa-solid fa-droplet text-cyan-400 text-2xl mb-4"></i>
                <h4 class="text-[11px] font-black uppercase mb-1">Sol Faucet</h4>
                <p class="text-2xl font-black italic mb-5">Gas Fee</p>
                <a href="https://faucet.solana.com/" target="_blank" class="block w-full bg-cyan-400/10 text-cyan-400 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-cyan-400/20">Get SOL</a>
            </div>
        </div>

        <div class="glass p-10 mb-20">
            <h3 class="text-xl font-black italic uppercase mb-10">Live Leaderboard</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-[10px] text-gray-600 uppercase border-b border-white/5 font-bold">
                        <tr><th>Rank</th><th>Pioneer Ref Code</th><th>Referrals</th><th>Total Points</th></tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="py-16 border-t border-white/5 text-center bg-black/20">
        <p class="text-[11px] font-bold text-gray-600 tracking-[0.6em] uppercase">Â© 2025 GrokMultiverse | Solana Devnet</p>
    </footer>

    <script>
        // 1. --- CONFIGURATION ---
        // *** UPDATED PROGRAM ID HERE ***
        const PROGRAM_ID = new solanaWeb3.PublicKey("DzsNMUqVhpyj6rznbph4jjDKTshPaKdWVHYHDBETYgXE"); 
        
        const network = "https://api.devnet.solana.com";
        const connection = new solanaWeb3.Connection(network, 'confirmed');
        window.Buffer = buffer.Buffer; // Polyfill for browser

        // 2. --- STATE MANAGEMENT ---
        let walletPublicKey = null;
        let provider = null;
        let program = null;
        let userAccount = null;

        // 3. --- IDL (MUST MATCH RUST SMART CONTRACT) ---
        const idl = {
            "version": "0.1.0",
            "name": "grok_multiverse",
            "instructions": [
                {
                    "name": "initializeUser",
                    "accounts": [
                        {"name": "userStats", "isMut": true, "isSigner": false},
                        {"name": "user", "isMut": true, "isSigner": true},
                        {"name": "systemProgram", "isMut": false, "isSigner": false}
                    ],
                    "args": [{"name": "referrerKey", "type": "publicKey"}]
                },
                {
                    "name": "dailyCheckIn",
                    "accounts": [
                        {"name": "userStats", "isMut": true, "isSigner": false},
                        {"name": "user", "isMut": false, "isSigner": true}
                    ],
                    "args": []
                }
            ],
            "accounts": [
                {
                    "name": "UserStats",
                    "type": {
                        "kind": "struct",
                        "fields": [
                            {"name": "owner", "type": "publicKey"},
                            {"name": "referrer", "type": "publicKey"},
                            {"name": "points", "type": "u64"},
                            {"name": "referralCount", "type": "u64"},
                            {"name": "lastCheckIn", "type": "i64"}
                        ]
                    }
                }
            ]
        };

        // 4. --- WALLET FUNCTIONS ---
        async function connectWallet() {
            try {
                const isPhantom = window.phantom?.solana?.isPhantom;
                const isSolflare = window.solflare?.isSolflare;

                let solanaProvider;
                if (isPhantom) solanaProvider = window.phantom.solana;
                else if (isSolflare) solanaProvider = window.solflare;
                
                // MWA / Deep Link for Mobile
                if (!solanaProvider) {
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        window.location.href = `https://phantom.app/ul/browse/${encodeURIComponent(window.location.href)}?ref=${window.location.href}`;
                        return;
                    }
                    return alert("Please install Phantom or Solflare Wallet!");
                }

                // Connect
                const response = await solanaProvider.connect();
                walletPublicKey = response.publicKey;

                // Setup Anchor
                provider = new anchor.AnchorProvider(connection, solanaProvider, anchor.AnchorProvider.defaultOptions());
                anchor.setProvider(provider);
                program = new anchor.Program(idl, PROGRAM_ID, provider);

                // Update UI
                document.getElementById('walletBtn').innerText = "LINKED";
                document.getElementById('addrDisplay').innerText = walletPublicKey.toString().slice(0, 4) + "..." + walletPublicKey.toString().slice(-4);
                
                // Show Referral Code (Last 6 Digits)
                const last6 = walletPublicKey.toString().slice(-6);
                document.getElementById('refCodeDisplay').innerText = last6;
                document.getElementById('referralBox').classList.remove('hidden');

                showToast("Wallet Synced Successfully");
                checkUserStatus(); // Check if account exists on-chain
            } catch (err) {
                console.error(err);
                showToast("Connection Error");
            }
        }

        // 5. --- SMART CONTRACT INTERACTIONS ---

        async function getUserStatsPDA() {
            const [pda, _] = await solanaWeb3.PublicKey.findProgramAddress(
                [Buffer.from("user-stats"), walletPublicKey.toBuffer()],
                PROGRAM_ID
            );
            return pda;
        }

        async function checkUserStatus() {
            if (!program) return;
            const btn = document.getElementById('mainActionBtn');
            const msg = document.getElementById('statusMsg');

            try {
                const pda = await getUserStatsPDA();
                const account = await program.account.userStats.fetch(pda);
                
                // User Exists
                userAccount = account;
                updateDashboard(account);
                
                // Setup Daily Button
                setupDailyButton(account.lastCheckIn.toNumber());

            } catch (e) {
                // User Does Not Exist
                console.log("User not initialized on-chain yet.");
                btn.innerText = "Initialize Account";
                btn.onclick = initializeUser;
                msg.innerText = "Costs ~0.002 SOL (One Time)";
                
                document.getElementById('totalPts').innerText = "0";
                document.getElementById('refCount').innerText = "0";
            }
        }

        function updateDashboard(account) {
            document.getElementById('totalPts').innerText = account.points.toString();
            document.getElementById('refCount').innerText = account.referralCount.toString();
            document.getElementById('badgeStatus').classList.remove('hidden');
        }

        function setupDailyButton(lastCheckInTimestamp) {
            const btn = document.getElementById('mainActionBtn');
            const msg = document.getElementById('statusMsg');
            const now = Math.floor(Date.now() / 1000);
            const oneDay = 86400; // seconds

            if (now > lastCheckInTimestamp + oneDay) {
                btn.innerText = "Daily Check-In (+10)";
                btn.onclick = handleDailyCheckIn;
                btn.disabled = false;
                msg.innerText = "Bonus Available!";
            } else {
                btn.innerText = "Come Back Tomorrow";
                btn.disabled = true;
                msg.innerText = "Next bonus in: " + new Date((lastCheckInTimestamp + oneDay) * 1000).toLocaleTimeString();
            }
        }

        // --- RPC: Initialize User ---
        async function initializeUser() {
            if (!program) return showToast("Connect Wallet First!");
            
            try {
                showToast("Initializing... Approve txn");
                const pda = await getUserStatsPDA();
                
                // Get Referrer from URL (?ref=PUBKEY)
                const urlParams = new URLSearchParams(window.location.search);
                const refParam = urlParams.get('ref');
                let referrerKey = walletPublicKey; // Default to self if no ref

                if (refParam) {
                    try {
                        // Check if valid pubkey
                        referrerKey = new solanaWeb3.PublicKey(refParam);
                    } catch (e) { console.log("Invalid ref code, ignoring"); }
                }

                await program.rpc.initializeUser(referrerKey, {
                    accounts: {
                        userStats: pda,
                        user: walletPublicKey,
                        systemProgram: solanaWeb3.SystemProgram.programId,
                    }
                });

                showToast("Account Initialized! +100 Pts");
                checkUserStatus(); // Refresh UI
            } catch (err) {
                console.error(err);
                showToast("Transaction Failed / Cancelled");
            }
        }

        // --- RPC: Daily Check In ---
        async function handleDailyCheckIn() {
            try {
                showToast("Claiming... Approve txn");
                const pda = await getUserStatsPDA();

                     await program.rpc.dailyCheckIn({
                    accounts: {
                        userStats: pda,
                        user: walletPublicKey
                    }
                });

                showToast("Points Claimed!");
                checkUserStatus(); // Refresh UI
            } catch (err) {
                console.error(err);
                showToast("Transaction Failed");
            }
        }

        // 6. --- UTILITIES ---
        function copyReferralLink() {
            if (!walletPublicKey) return showToast("Connect Wallet First");
            
            // Logic: Link contains FULL Public Key, UI shows Last 6
            const url = window.location.href.split('?')[0];
            const refLink = `${url}?ref=${walletPublicKey.toString()}`;
            
            navigator.clipboard.writeText(refLink);
            showToast("Referral Link Copied!");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; 
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Mock Leaderboard (JS renders this locally)
        const mockLeaderboard = [
            {code: "9x...2A4b", refs: 154, pts: 32000},
            {code: "4L...9pLx", refs: 82, pts: 14500},
            {code: "8m...k2Qq", refs: 12, pts: 2100}
        ];

        const tbody = document.getElementById('leaderboardBody');
        if(tbody) {
            tbody.innerHTML = mockLeaderboard.map((p, i) => `
                <tr class="border-b border-white/5 hover:bg-white/[0.01] transition">
                    <td class="py-4 font-bold text-cyan-400">#${i+1}</td>
                    <td class="py-4 font-mono text-xs uppercase text-gray-300">${p.code}</td>
                    <td class="py-4 font-bold">${p.refs}</td>
                    <td class="py-4 font-black italic text-white">${p.pts.toLocaleString()}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
